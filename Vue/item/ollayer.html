<html>
    <title></title>
    <body>
        
    </body>
    <script>
        $(function(){
            var projection_4545 = new ol.proj.Projection({
                code:"EPSG:4545",
                extent:[341292.83,2012,20122660.02,623358.78,4704933.83],
                units:"metrem",
                axisOrientaion:'neu'
            })


            $('#znxd-maptools').mouseenter(function(){
                $('.znxd-maptool').animate({left:40},400,"swing",function () {  })
            });
            $('#znxd-maptools').mouseenter(function(){
                $('.znxd-maptool').animate({left:40},400,"swing",function () {  })
            });

            $("#znxd-maptool-py").click(function(){
                mapTool("dragPan");
                //平移
            });
            $("#znxd-maptool-fd").click(function(){
                mapTool("zoomIn");
        //放大
            });
            $("#znxd-maptool-sx").click(function(){
                mapTool("zoomOut");
        //缩小
            });
            $("#znxd-maptool-xz").click(function(){
        //框选
                mapTool("select");
            });

            $("#znxd-maptool-qcxz").click(function(){
        //清除选择
                mapTool("clear");
            });
            $("#znxd-maptool-qt").click(function(){
        //全图
                mapTool("init");
            });

            var Namespace = new Object();
            Namespace.register = function(path){
                var arr = path.split('.');
                var ns = "";
                for(var i=0;i<arr.length;i++){
                    if(i>0) ns+=".";
                    ns += arr[i];
                    eval("if(typeof(" + ns + ") == 'undefined')" + ns +" = new Object();");
                }
            }

            var map;
            var ZNXDWEBGIS = {
                map:null,
                wfsLayer:null,
                drawLayer:null,
                drawGraphics:null,
                baseTool:null,
                measureTool:null,
                theaticMap:null,
                zoom:5,
                ol3d:null,
                ol3dZoomIn:null,
                dragZoomOut:null,
                dragPan:null,
                selectSource:null,
                initCenter:null,
                initZoom:null,
                selectClick:null,
                dragBox:null,
                selectLayer:null,
                container:null,
                content:null,
                title:null,
                overlay:null,
                selectedFeatures:null,
                DDKBM:null,
                showBase:"cia",
                geoserverurl:"http://192.168.1.156:9999/geoserver",    
                wfsServerUrl: "http://192.168.1.156:9999/geoserver/xjpt",
                wfsFeatureTyp:"CBDKXX",
                namespace:'xjpt',
                namespaceuri:"xjpt",
                extent: [-20037508.342789244, -20037508.342789244, 20037508.342789244, 20037508.342789244],
                bounds: [-180.0, -90.0, 180.0, 90.0], //地图范围
                center: [109.30013, 34.48039],
                formatWKT:new ol.format.WKT(),
                projection:"EPSG:4326",
                formatWFS:new ol.format.WFS(),
                formatJSON:new ol.format.GeoJSON(),
                srcProjection:"EPSG:4545",
                toprojection:"EPSG:4326"
            };
            var projection = ol.proj.get(ZNXDWEBGIS.toProjection);
            var projectionExtent = projection.getExtent();
            var size = ol.extent.getWidth(projectionExtent) /256;

            var resolutions = new Array(21);
            var matrixIds = new Array(21);
            for(var z=0;z<21;++z){
                resolutions[z] = size/Math.pow(2,z);
                matrixIds[z] = z;
            }
            
            var tiandituLayer = new ol.layer.Tile({
                tile:"vec",
                type:"base",
                visible:true,
                matrixSet:ZNXDWEBGIS.toProjection,
                extent:ZNXDWEBGIS.bounds,
                format:"image/png",
                source:new ol.source.WMTS({
                    url:"https://to.tianditu.com/vec_c/wmts",
                    layer:"vec",
                    matrixSet:"c",
                    tileGrid:new ol.tilegrid.WMTS({
                        origin:ol.extent.getTopLeft(projectionExtent),
                        resolutions:resolutions,
                        matrixIds:matrixIds
                    }),
                    format:"tiles",
                    style:"default"
                })
            });

            var tiandituSatelliteLayer = new ol.layer.Tile({
                title:"cia",
                type:'base',
                visible:false,
                matrixSet:ZNXDWEBGIS.toProjection,
                extent:ZNXDWEBGIS.bounds,
                source:new ol.source.XYZ({
                    url:"http://t3.tianditu.cn/DataServer?T=img_w&X={x}&Y={y}&L={z}"
                })
            });
            // 本地服务
            var ncDK = new ol.layer.Tile({
                visible:false,
                title:"ncDK",
                extent:ZNXDWEBGIS.bounds,
                source:new ol.source.tileWMS({
                    url:ZNXDWEBGIS.geoserverurl + '/gwc/service/wms',
                    params:{
                        LAYERS:"xjpt:NCDK",
                        FORMAT:"image/png",
                        VERSION:"1.1.0",
                        tiled:true,
                        STYLES:""
                    }
                })
            })

            var sourceVector = new ol.source.Vector({
                projection:ZNXDWEBGIS.srcProjection,
                loader:function(extent){
                    $.ajax(ZNXDWEBGIS.wfsServerURl + 'ows',{
                        type:"GET",
                        dataType:"json",
                        data:{
                            service:"WFS",
                            version:"1.1.0",
                            request:"GetFeature",
                            typename:"CBDKXX",
                            srsname:ZNXDWEBGIS.srcProjection,
                            bbox:extent.join(',')+','+ZNXDWEBGIS.srcProjection,
                                outputFormat:"application/json"
                        }
                    }).done(function(response){
                        sourceVector.addFeatures(ZNXDWEBGIS.formatJSON.readFeatures(response));
                    });
                },
                strategy:ol.loadingstrategy.bbox
            })
            ZNXDWEBGIS.wfsLayer = new ol.layer.Vector({
                title:"WFS图层",
                extent:ZNXDWEBGIS.bounds,
                source:function(feature){
                    return getStyle(feature,"point")
                }
            })
            var localSource = new ol.source.Vector({
                projection:ZNXDWEBGIS.srcProjection
            })
            var localLayer = new ol.layer.Vector({
                title:"定位图层",
                source:localSource,
                style:function(feature){
                    return getStyle(feature,"ployon");
                }
            })
            var oneColor = ["#cdf0bd", "#6fc64b", "#459924", "#207300", "#005830"];
            var colors = ["#cdf0bd", "#6fc64b", "#459924", "#207300", "#005830"];

            function getStyle(feature, flag) {
                
                    var style = null;
                
                    if(flag == "ployon") {
                                        //获取所有属性名和值的对象。
                        var name = feature.getProperties().CNAME;
                        if(name == "香港特别行政区" || name == "澳门特别行政区") {
                            name = "";
                        }
                
                        style = new ol.style.Style({
                            fill: new ol.style.Fill({
                
                                color: "#ffffde"
                            }),
                            stroke: new ol.style.Stroke({
                                color: "#d0dcde",
                                width: "5px"
                            }),
                            text: new ol.style.Text({
                                font: "14px 微软雅黑",
                                text: name,
                                fill: new ol.style.Fill({
                                    color: "#000000"
                                }),
                                stroke: new ol.style.Stroke({
                                    color: "#ffffff",
                                    width: "15px"
                                })
                            }),
                            geometry: function(feature) {
                                //返回主要面积图形		//获取功能的默认几何  //返回此多边形的多边形
                                var polygons = feature.getGeometry().getPolygons();
                                var polygon = polygons[0];
                                if(name == "福建省" || name == "浙江省" || name == "四川省" || name == "河北省" || name == "海南省" || name == "广东省") {
                                    polygon = polygons[polygons.length - 1];
                                }
                                return polygon;
                                    //多边形
                            }
                        })
                    }
                    return style;
                }
        var styleCache = {};
        var clusters = new ol.layer.Vector({
            source:clusterSource,
            style:function(feature){
                var size = feature.get('features').length;
                var style = styleCache[size];
                if(!style){
                    style = new ol.style.Style({
                        image:new ol.style.Circle({
                            radius:10,
                            stroke:new ol.style.Stroke({
                                color:"fff"
                            }),
                            fill:new ol.style.Fill({
                                color:"#3399cc"
                            }),
                            text:new ol.style.Text({
                                text:size.toString(),
                                fill:new ol.style.Fill({
                                    color:"#fff"
                                })
                            })
                        });
                    })
                    styleCache[size] = style;
                }
                return style;
            }
           
        });

        var raster = new ol.layer.Tile({
            source:new ol.source.OSM()
        });
        var map = new ol.Map({
            layers:[raster,clusters],
            target:'map',
            view:new ol.View({
                center:[0,0],
                zoom:2
            })
        })








        });
    </script>
</html>